# Universal Parser Project

### Сюда включены мониторинг и парсеры написаные на TypeScript испольняющиеся в среде NodeJS

### Содержимое:
  - [Общее](#Общее)
    - [Среда](#Среда)
    - [Язык программирования](#Язык-программирования)
  - [Парсеры](#Парсеры)
    - [Виды парсеров](#Виды-парсеров)
    - [Для аптек](#Для-аптек)
  - [Мониторинг](#Мониторинг)
    - [Серверная часть](#Серверная-часть)
    - [Интерфейс](#Интерфейс)
    - [Подключение компьютеров](#Подключение-компьютеров)
  - [ВПН](#ВПН)
  
### Общее

### Среда
Дебаг, запуск, сборка приложений происходит по средством NodeJS и менеджера пакетов NPM.
Подробную документацию можно найти при помощи Google, здесь же я опишу вкратце о участии в проекте.

В папках `server`, `ui`, `parser` есть файл `package.json`, в котором необходимо выделить 3 основных ключа: `scripts`, `dependencies` и `devDependencies`.
  - `"scripts"`
    При вызове в директории содержащей `package.json` команды `npm run *script*`, выполнится соответсвующая командная строка
  - `"dependencies"`
    Перечисленные пакеты соответсвующих версий будут установлены командой `npm install`, в том числе командой `npm install --only=production`
  - `"devDependencies"` 
    Такая же установка пакетов, но при наличи флага `--only=production` пакеты игнорируются
Замечу в некоторых `package.json` в списке `scripts` вызов команды `npx`: `npx tsc`, `npx run-s`.
`npx` представляет собой утилиту для вызова скаченных пакетов, например `tsc` идет вместе с пакетом `typescript`, и используется для компиляции TypeScript'a.
Но не всегда `tsc` или `run-s` попадают в PATH системы Windows, с чем помогает справиться `npx`.
И обращу еще внимание на `run-s` идущий вместе с пакетом `npm-run-all`, позволяет вызывать сразу несколько скриптов одной командой, по очереди или параллельно.

(Подробнее смотрите [parser/package.json](https://github.com/Shesmuu/upp/blob/main/parser/package.json))

### Язык программирования
Все части UPP написаны на TypeScript, за исключением небольших скриптов на JavaScript и Python.
Если вы не знакомы с TypeScript, но желаете разобраться, рекомендую изучить от и до
https://metanit.com/web/typescript/1.1.php
О том что же мы имеем конкретно в нашем проекте:
 - В папках `server`, `ui`, `parser` имеется `tsconfig.json`, который при вызове команды `tsc` с флагом `-p`,
   мы указываем папку, чаще всего `.` используется для компиляции определенного приложения
   `tsc -p .`. С флагом `--watch` комплияция происходит в реальном времени
 - Так же в `server/src`, `ui/src`, `parser/src` имеется папка `types`, в которой находятся `.d.ts` файлы, описывающие все типы соответсвующей среды
 - И конечно есть общие типы для всего UPP находящиеся в папке types, в главной директории

### Парсеры
Каждый сайт уникален, на нем свой дизайн, своя пагниация и своя защита от парсинга/ддоса.
В результате чего к каждому нужно искать индивидуальный подход, стараясь выиграть в скорости парсинга.
Я бы разделил сайты на 3 уровня защиты:
 - 0 - можно получить HTML страницу обычным HTTP/HTTPS запросом, из любого языка программирования (JS, Python).
 Здесь никаких проблем, берем и парсим запросами с допустимым интервалом.
 - 1 - получить страницу невозможно, или не имеет смысла, так-как на ней должен выполниться JavaScript.
 Раньше я бы использовал NightmareJS или Selenium, но 2й уровень защиты заставил отказаться, сначала в некоторых, а потом и во всех случаях от этого способа.
 - 2 - NightmareJS и Selenium не могут открыть сайт.
 Такие сайты действительно были проблемными для парсинга, но если реальные пользователи могли на него зайти, значит может и парсер.
 В результате чего я разработал парсеры на основе браузерного расширения,
 которые позволяют парсить сайты в вкладке браузера без единого отличия от реального пользователя.
 
### Запуск
Запустить парсер можно двумя способами один раз, вызвав команду `npm run start-once`,
или запустить в, что можно назвать "сейф моде", вызвав команду `npm run start`.
В результате чего будет вызван скрипт
[`manage.js`](https://github.com/Shesmuu/upp/blob/main/parser/scripts/manage.js)
, который в случае неудачного исполнения парсера перезапустит его.
И в первом и во втором случае, указывать параметры парсера необходимо после `--`, через пробел и равно.

(Например `npm run start -- parser=april city=Пермь local=1`).

Среди параметров запуска доступны
 - `local=1` - запустит парсер локально.
 - `noupload=1` - по завершению не станет выгружать в программу.

### Виды парсеров
Изначально я бы разделил парсеры на 2 типа "[Сокетный](https://github.com/Shesmuu/upp/blob/main/parser/src/components/parsing.ts#L206)" и "[Локальный](https://github.com/Shesmuu/upp/blob/main/parser/src/components/local.ts#L103)".
Первый как ясно из названия, подключается к чему-то, а именно к нашему моинторингу, речь о котором пойдет далее, но суть в том,
что парсер передает все данные:
[информацию о товарах](https://github.com/Shesmuu/upp/blob/main/parser/src/components/parsing.ts#L276),
[кэш](https://github.com/Shesmuu/upp/blob/main/parser/src/components/parsing.ts#L261), 
[хранилище](https://github.com/Shesmuu/upp/blob/main/parser/src/components/parsing.ts#L266)
серверу, через
[`ws://`](https://github.com/Shesmuu/upp/blob/main/parser/src/components/parsing.ts#L212)
подключение.
Локальный же всю информацию о товарах сохраняет локально на компьютере в `.csv` файл,
а кэш и хранилище хранит в папке `parser/local` в `.data` файлах собственного формата.
Для запуска локально, достаточно добавить в параметры запуска `local=1`.
Но не все парсеры могут работать локально, а именно работающие через браузерное расширешние, о чем будет описано позже.

### Расширение
Как упоминалось выше, расширение работает исключительно через подключение к Мониторингу,
из-за отсутсвия в наборе инструментов Chrome для расширений редактировать файлы на компьютере или запускать процессы.

Чтобы начать работу с расширениями, необходимо вызвать команду `npm run build-extension` в папке `parser`,
после чего зайти в контекстное меню Google Chrome
(3 вертикальных точки под крестиком в верхнем правом углу окна)
"Дополнительные инструменты" > "Расширения" > включить "Режим разработчика" > "Загрузить распакованное расширение"
и выбрать папку [`parser/extension`](https://github.com/Shesmuu/upp/tree/main/parser/extension)

Не забывайте после каждого изменения необходимо вызывать команду `npm run build-extension` в папке `parser` и перезагружать расширение в Google Chrome.

### Расширение и Мониторинг
Расширение выполняет роль не только парсера, собирающего информацию с сайта, но и менеджера по запуску этих самых парсеров.
Вазимодейтвие менеджера и Мониторинга будет описано ниже.

### ВПН
На момент написания этого README файла, в качестве VPN использовался сервис hidemy.name.
Для продления необходимо оплатить доступ на n-e количество времени на сайте сервиса https://hidemy.name/

Настройка:
  - Ввести код доступа из сообщения после оплаты
  - При подключении к мониторингу, добавить в исключения IP-адрес компьютера, на котором расположен сервер Мониторинга

При работе с ним можно столкнуться с некоторыми проблемами.
Почти все из которых решаются по следующей схеме:
  - Закрыть ВПН
  - Удалить с компьютера полностью
  - Перезагрузить компьютер
  - Скачать портативную версию отсюда: https://hidemy.name/get-windows-portable/
  - Вынести папку из архива и запустить, настроить с нуля
